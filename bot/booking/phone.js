import { Telegraf, Markup, Scenes } from "telegraf";

// –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É —Å—Ü–µ–Ω—É –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
const phone = new Scenes.BaseScene("phone");

// –ü—Ä–∏ –≤—Ö–æ–¥—ñ –≤ —Å—Ü–µ–Ω—É –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é
phone.enter(async (ctx) => {
  await ctx.replyWithHTML(
    "üì± –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —É —Ñ–æ—Ä–º–∞—Ç—ñ <code>+380123456789</code>",
    Markup.keyboard([["–ù–∞–∑–∞–¥"]])
      .resize()
      .oneTime()
  );
  // –¶–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è-—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è. –ù–∞–≥–∞–¥—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä.
  // –ú–æ–∂–Ω–∞ –ø—ñ–∑–Ω—ñ—à–µ –∑–∞–º—ñ–Ω–∏—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏–π —à–∞–±–ª–æ–Ω: +380XXXXXXXXX
});

// –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" ‚Äî –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Å—Ü–µ–Ω–∏ –∑ –≤–≤–µ–¥–µ–Ω–Ω—è–º —ñ–º–µ–Ω—ñ
phone.hears("–ù–∞–∑–∞–¥", async (ctx) => {
  return ctx.scene.enter("fullName"); // –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å—Ü–µ–Ω–∏ (–≤–≤–µ–¥–µ–Ω–Ω—è –ü–Ü–ë)
});

// –û–±—Ä–æ–±–∫–∞ –±—É–¥—å-—è–∫–æ–≥–æ —Ç–µ–∫—Å—Ç—É (–ø–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å –Ω–æ–º–µ—Ä)
phone.on("text", async (ctx) => {
  const input = ctx.message.text.trim(); // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏
  const regex = /^\+380\d{9}$/; // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –Ω–æ–º–µ—Ä: +380 —ñ 9 —Ü–∏—Ñ—Ä

  // –Ø–∫—â–æ –Ω–æ–º–µ—Ä –≤–≤–µ–¥–µ–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –≤–∏–≤–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
  if (!regex.test(input)) {
    await ctx.reply(
      "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ü—Ä–∏–∫–ª–∞–¥: +380937465892. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
      Markup.keyboard([["–ù–∞–∑–∞–¥"]])
        .resize()
        .oneTime()
    );
    return;
  }

  // –Ø–∫—â–æ –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ‚Äî —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ –¥–ª—è –∫—Ä–∞—Å–∏
  const formatted = input.replace(
    /(\+380)(\d{2})(\d{3})(\d{2})(\d{2})/,
    "$1($2)-$3-$4-$5" // –ü—Ä–∏–∫–ª–∞–¥: +380(93)-746-58-92
  );

  ctx.session.data.phoneNumber = formatted; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ —Å–µ—Å—ñ—é

  await ctx.reply(
    "‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —É—Å–ø—ñ—à–Ω–æ –≤–≤–µ–¥–µ–Ω–∏–π!",
    Markup.removeKeyboard()
  );

  return ctx.scene.enter("checkData"); // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Å—Ü–µ–Ω–∏ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∞–Ω–∏—Ö
});

export { phone };
