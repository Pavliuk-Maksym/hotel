import { Telegraf, Markup, Scenes } from "telegraf";

// –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É –¥–ª—è –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const phone = new Scenes.BaseScene("phone");

// –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å—Ü–µ–Ω—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
phone.enter(async (ctx) => {
  await ctx.replyWithHTML(
    "üì± –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —É —Ñ–æ—Ä–º–∞—Ç—ñ <code>+380123456789</code>",
    Markup.keyboard([["–ù–∞–∑–∞–¥"]])
      .resize()
      .oneTime()
  );
  // –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è. –ù–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä.
  // –ú–æ–∂–Ω–æ –ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω: +380XXXXXXXXX
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ü–µ–Ω–µ —Å –≤–≤–æ–¥–æ–º –∏–º–µ–Ω–∏
phone.hears("–ù–∞–∑–∞–¥", async (ctx) => {
  return ctx.scene.enter("fullName"); // –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ü–µ–Ω–µ (–≤–≤–æ–¥ –§–ò–û)
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä)
phone.on("text", async (ctx) => {
  const input = ctx.message.text.trim(); // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
  const regex = /^\+380\d{9}$/; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π –Ω–æ–º–µ—Ä: +380 –∏ 9 —Ü–∏—Ñ—Ä

  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –≤–≤–µ–¥—ë–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  if (!regex.test(input)) {
    await ctx.reply(
      "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–∫–ª–∞–¥: +380937465892. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
    );
    return;
  }

  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
  const formatted = input.replace(
    /(\+380)(\d{2})(\d{3})(\d{2})(\d{2})/,
    "$1($2)-$3-$4-$5" // –ü—Ä–∏–º–µ—Ä: +380(93)-746-58-92
  );

  ctx.session.data.phoneNumber = formatted; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏—é

  return ctx.scene.enter("checkData"); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω–µ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
});

export { phone };
